<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group18 Compiler | Online Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="stylesheets/styles.css">
    <style>
        /* Syntax color variables are now inherited from styles.css :root and .dark-mode */

        * {
            box-sizing: border-box;
            scrollbar-color: var(--border) transparent;
            scrollbar-width: thin;
        }

        body {
            margin: 0;
            padding: 0;
            /* Override styles.css padding */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            width: 100%;
            /* Ensure full width */
            max-width: none;
            /* Override styles.css wrapper limits if any applied to body, though they are usually on .wrapper */
        }

        header {
            width: 100%;
            position: static;
            float: none;
            padding: 1rem 2rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            flex-shrink: 0;
            height: auto;
        }

        header ul {
            /* Reset styles.css header ul if it conflicts, though we don't use ul here */
            display: none;
        }

        .logo {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--heading);
            display: flex;
            align-items: center;
            gap: 10px;
            justify-self: start;
        }

        .learn-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 24px;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s ease;
            justify-self: center;
            line-height: 1;
        }

        .learn-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--shadow);
            border-color: var(--primary);
            /* subtle highlight on hover */
        }

        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            flex-grow: 1;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
        }

        .output-container {
            height: 200px;
            min-height: 100px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            flex-shrink: 0;
            position: relative;
        }

        .resize-handle {
            height: 5px;
            background: var(--border);
            cursor: ns-resize;
            width: 100%;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resize-handle:hover,
        .resize-handle.active {
            background: var(--primary);
        }

        .console {
            flex-grow: 1;
            padding: 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            color: var(--code-text);
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 1px solid var(--border);
            background: var(--code-bg);
        }

        .pane {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            overflow: hidden;
        }

        .pane-header {
            padding: 0.5rem 1rem;
            background: var(--surface-alt);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-shrink: 0;
        }

        .pane-content {
            flex-grow: 1;
            overflow: hidden;
            position: relative;
            background: var(--bg);
        }

        /* Standardized Editor Layers */
        .editor-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--bg);
        }

        #editor-textarea,
        #editor-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 1.5rem;
            font-family: 'Fira Code', 'Cascadia Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre;
            word-wrap: normal;
            overflow: auto;
            tab-size: 4;
            letter-spacing: normal;
            font-variant-ligatures: normal;
        }

        #editor-textarea {
            background: transparent;
            color: transparent;
            caret-color: var(--code-text);
            z-index: 2;
            resize: none;
            border: none;
            outline: none;
        }

        #editor-highlight {
            z-index: 1;
            color: var(--code-text);
            pointer-events: none;
            background: transparent;
        }

        /* Syntax Colors - Adjusted for Light Theme */
        .hl-kw {
            color: var(--syn-kw);
            font-weight: bold;
        }

        .hl-type {
            color: var(--syn-type);
            font-weight: bold;
        }

        .hl-str {
            color: var(--syn-str);
        }

        .hl-num {
            color: var(--syn-num);
        }

        .hl-atom {
            color: var(--syn-atom);
        }

        .hl-cmt {
            color: var(--syn-comment);
            font-style: italic;
        }

        .hl-fn {
            color: var(--syn-fn);
            font-weight: bold;
        }

        pre#output {
            margin: 0;
            padding: 1.5rem;
            color: var(--code-text);
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre;
            overflow: auto;
            height: 100%;
            width: 100%;
            background: var(--code-bg);
            /* Use code background */
            border: none;
            /* Remove border from styles.css pre */
        }

        .controls {
            padding: 1rem 2rem;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            flex-shrink: 0;
        }

        button {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }

        .btn-primary {
            background: #238636;
            /* Green for Run */
            color: #fff;
        }

        .btn-primary:active {
            background: #1a6328;
        }

        .btn-run {
            background: #e2b714;
            /* Yellow for Compile */
            color: #000;
        }

        .btn-run:active {
            background: #c5a012;
        }

        .btn-secondary {
            background: var(--surface-alt);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Specific overrides */
        #compile-btn {
            background: #e2b714;
            /* Yellow */
            color: #000;
        }

        #compile-btn:active {
            background: #c5a012;
        }

        #run-btn {
            background: #238636;
            /* Green */
            color: #fff;
        }

        #run-btn:active {
            background: #1a6328;
        }

        #reset-btn {
            /* Will attach btn-secondary class but maybe a specific color if desired, currently using secondary */
            background: #d64040;
            /* Reddish for reset? User just said "different base color" */
            color: #fff;
            border: none;
        }

        #reset-btn:hover {
            background: #b53535;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .status {
            font-size: 0.8rem;
            color: var(--text-dim);
            /* Remove margin-left: auto so we rely on space-between */
            align-self: center;
            justify-self: end;
        }

        /* Dropdown styling */
        /* Dropdown styling */
        select {
            background: var(--surface) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
            cursor: pointer;
        }

        select:hover {
            border-color: var(--primary) !important;
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">Group18 Compiler</div>
        <a href="g18_docs.html" target="_blank" class="learn-btn" aria-label="Documentation">‚ùì</a>
        <div class="status" id="status">WASM Loading...</div>
    </header>

    <main>
        <div class="pane">
            <div class="pane-header">
                Input (.g18)
                <select id="example-select"
                    style="border-radius: 4px; padding: 2px 4px; font-size: 0.8rem; margin-left: 10px;">
                    <option value="Verify Identity Matrix">Verify Identity Matrix</option>
                    <option value="Fibonacci and Number Theory">Fibonacci and Number Theory</option>
                    <option value="Matrix Operations Suite">Matrix Operations Suite</option>
                    <option value="Searching and Sorting">Searching and Sorting</option>
                    <option value="String Processing">String Processing</option>
                </select>
            </div>
            <div class="pane-content">
                <div class="editor-container">
                    <pre id="editor-highlight" aria-hidden="true"></pre>
                    <textarea id="editor-textarea" spellcheck="false" autocomplete="off"></textarea>
                </div>
            </div>
        </div>
        <div class="pane" style="border-right: none;">
            <div class="pane-header">
                Output View
                <div style="display: flex; gap: 5px;">
                    <button class="btn-secondary" style="padding: 2px 8px; font-size: 10px;" id="toggle-view">View
                        WAT</button>
                    <button class="btn-secondary" style="padding: 2px 8px; font-size: 10px;"
                        onclick="copyOutput()">Copy</button>
                </div>
            </div>
            <div class="pane-content">
                <pre id="output">Compiled assembly will appear here...</pre>
            </div>
        </div>
    </main>

    <div class="resize-handle" id="resize-handle"></div>
    <div class="output-container" id="output-container">
        <div class="pane-header">Console Output</div>
        <div class="console" id="console">> Welcome to Group18 Compiler.</div>
    </div>

    <div class="controls">
        <button class="btn-primary" id="compile-btn">Compile to ASM</button>
        <button class="btn-run" id="run-btn">Run Program</button>
        <button class="btn-secondary" id="reset-btn" onclick="resetCode()">Reset</button>
    </div>

    <button id="theme-toggle" aria-label="Toggle dark mode">üåô</button>

    <script type="module">
        import init, { compile_g18, compile_wat_g18, compile_wasm_g18 } from './pkg/Group18.js';

        const textarea = document.getElementById('editor-textarea');
        const highlight = document.getElementById('editor-highlight');
        const outputArea = document.getElementById('output');
        const consoleArea = document.getElementById('console');
        const compileBtn = document.getElementById('compile-btn');
        const runBtn = document.getElementById('run-btn');
        const toggleBtn = document.getElementById('toggle-view');

        // Theme Toggle Logic
        const themeBtn = document.getElementById('theme-toggle');
        const body = document.body;

        // Check local storage (default to dark)
        if (localStorage.getItem('theme') !== 'light') {
            body.classList.add('dark-mode');
            themeBtn.textContent = '‚òÄÔ∏è';
        }

        themeBtn.addEventListener('click', () => {
            body.classList.toggle('dark-mode');

            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeBtn.textContent = '‚òÄÔ∏è';
            } else {
                localStorage.setItem('theme', 'light');
                themeBtn.textContent = 'üåô';
            }
        });

        // Console Resize Logic
        const handle = document.getElementById('resize-handle');
        const outputContainer = document.getElementById('output-container');
        let isResizing = false;

        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            handle.classList.add('active');
            document.body.style.cursor = 'ns-resize';
            e.preventDefault(); // Prevent text selection
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerHeight = window.innerHeight - e.clientY;
            // Enforce min/max constraints
            if (containerHeight > 100 && containerHeight < (window.innerHeight - 100)) {
                outputContainer.style.height = `${containerHeight}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                handle.classList.remove('active');
                document.body.style.cursor = '';
            }
        });

        let currentView = 'asm';
        let moduleMemory = null;

        const examplePrograms = {
            "Verify Identity Matrix": `fn is_identity(i32s[][] m) -> bool {
    for i in 0 to 3 {
        for j in 0 to 3 {
            if i == j {
                if m[i][j] != 1 { return false; }
            } else {
                if m[i][j] != 0 { return false; }
            }
        }
    }
    return true;
}

fn main() -> i32s {
    i32s[][] matrix = [
        [1, 0, 0],
        [0, 1, 0],
        [0, 0, 1]
    ];

    print("Matrix is identity: ");
    println(is_identity(matrix));

    return 0;
}
`,
            "Fibonacci and Number Theory": `fn fibonacci() -> i32s[] {
    i32s[] fib = [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 
                  0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    
    for i in 2 to 20 {
        fib[i] = fib[i - 1] + fib[i - 2];
    }
    
    return fib;
}

fn is_fibonacci(i32s num, i32s[] fib_seq) -> bool {
    for i in 0 to 20 {
        if fib_seq[i] == num {
            return true;
        }
        if fib_seq[i] > num {
            return false;
        }
    }
    return false;
}

fn sum_of_divisors(i32s n) -> i32s {
    i32s sum = 0;
    for i in 1 to n {
        i32s quotient = n / i;
        i32s product = quotient * i;
        if product == n {
            sum = sum + i;
        }
    }
    return sum;
}

fn is_perfect_number(i32s n) -> bool {
    i32s sum = sum_of_divisors(n);
    if sum == n {
        return true;
    }
    return false;
}

fn gcd(i32s a, i32s b) -> i32s {
    for i in 0 to 1000 {
        if b == 0 {
            return a;
        }
        i32s temp = b;
        i32s quotient = a / b;
        b = a - (quotient * b);
        a = temp;
    }
    return a;
}

fn main() -> i32s {
    println("Fibonacci sequence up to 20:");
    i32s[] fib_nums = fibonacci();
    
    for i in 0 to 20 {
        print(fib_nums[i]);
        print("   ");
    }
    println("");
    println("");
    
    print("Testing if 13 is a Fibonacci number: ");
    println(is_fibonacci(13, fib_nums));
    
    println("");

    print("Testing if 14 is a Fibonacci number: ");
    println(is_fibonacci(14, fib_nums));

    println("");
    
    println("Perfect numbers up to 30:");
    for i in 1 to 30 {
        if is_perfect_number(i) {
            print(i);
            print("   ");
        }
    }
    println("");
    println("");
    
    print("GCD of 48 and 18: ");
    println(gcd(48, 18));
    
    println("");

    print("GCD of 100 and 35: ");
    println(gcd(100, 35));
    
    return 0;
}
`,
            "Matrix Operations Suite": `fn matrix_multiply(f32s[][] a, f32s[][] b, i32s n) -> f32s[][] {
    f32s[][] result = [
        [0.0, 0.0, 0.0],
        [0.0, 0.0, 0.0],
        [0.0, 0.0, 0.0]
    ];
    
    for i in 0 to n {
        f32s[] row = [0.0, 0.0, 0.0];
        for j in 0 to n {
            f32s sum = 0.0;
            for k in 0 to n {
                sum = sum + (a[i][k] * b[k][j]);
            }
            row[j] = sum;
        }
        result[i] = row;
    }
    
    return result;
}

fn matrix_transpose(f32s[][] m, i32s n) -> f32s[][] {
    f32s[][] result = [
        [0.0, 0.0, 0.0],
        [0.0, 0.0, 0.0],
        [0.0, 0.0, 0.0]
    ];
    
    for i in 0 to n {
        f32s[] row = [0.0, 0.0, 0.0];
        for j in 0 to n {
            row[j] = m[j][i];
        }
        result[i] = row;
    }
    
    return result;
}

fn is_symmetric(f32s[][] m, i32s n) -> bool {
    for i in 0 to n {
        for j in 0 to n {
            f32s diff = m[i][j] - m[j][i];
            if diff > 0.001 {
                return false;
            }
            if diff < -0.001 {
                return false;
            }
        }
    }
    return true;
}

fn matrix_trace(f32s[][] m, i32s n) -> f32s {
    f32s trace = 0.0;
    for i in 0 to n {
        trace = trace + m[i][i];
    }
    return trace;
}

fn matrix_max(f32s[][] m, i32s n) -> f32s {
    f32s max = m[0][0];
    for i in 0 to n {
        for j in 0 to n {
            if m[i][j] > max {
                max = m[i][j];
            }
        }
    }
    return max;
}

fn compare_matrices(f32s[][] a, f32s[][] b, i32s n) -> bool {
    for i in 0 to n {
        for j in 0 to n {
            if a[i][j] != b[i][j] {
                return false;
            }
        }
    }
    return true;
}

fn main() -> i32s {
    i32s size = 3;
    
    f32s[][] mat_a = [
        [1.5, 2.0, 3.0],
        [4.0, 5.5, 6.0],
        [7.0, 8.0, 9.5]
    ];
    
    f32s[][] mat_b = [
        [1.0, 0.0, 0.0],
        [0.0, 1.0, 0.0],
        [0.0, 0.0, 1.0]
    ];
    
    println("Testing matrix operations:");
    
    f32s[][] product = matrix_multiply(mat_a, mat_b, size);
    print("Matrix A * Identity = A: ");
    println(compare_matrices(product, mat_a, size));
    
    f32s[][] transposed = matrix_transpose(mat_b, size);
    print("Identity is symmetric: ");
    println(is_symmetric(transposed, size));
    
    f32s trace = matrix_trace(mat_a, size);
    print("Trace of matrix A: ");
    println(trace);
    
    f32s max_val = matrix_max(mat_a, size);
    print("Maximum value in matrix A: ");
    println(max_val);
    
    if max_val > 9.0 {
        if max_val <= 10.0 {
            println("Max is between 9 and 10");
        }
    } else {
        println("Max is 9 or less");
    }
    
    return 0;
}
`
            ,
            "String Processing": `fn count_char(char[] text, i32s len, char target) -> i32s {
    i32s count = 0;
    for i in 0 to len {
        if text[i] == target {
            count = count + 1;
        }
    }
    return count;
}

fn find_first(char[] text, i32s len, char target) -> i32s {
    for i in 0 to len {
        if text[i] == target {
            return i;
        }
    }
    return -1;
}

fn find_last(char[] text, i32s len, char target) -> i32s {
    i32s last = -1;
    for i in 0 to len {
        if text[i] == target {
            last = i;
        }
    }
    return last;
}

fn reverse_string(char[] text, i32s len) -> char[] {
    char[] result = ['x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x',
                     'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x'];
    for i in 0 to len {
        result[i] = text[len - 1 - i];
    }
    return result;
}

fn is_palindrome(char[] text, i32s len) -> bool {
    i32s half = len / 2;
    for i in 0 to half {
        if text[i] != text[len - 1 - i] {
            return false;
        }
    }
    return true;
}

fn strings_equal(char[] str1, char[] str2, i32s len) -> bool {
    for i in 0 to len {
        if str1[i] != str2[i] {
            return false;
        }
    }
    return true;
}

fn copy_substring(char[] source, i32s start, i32s end) -> char[] {
    char[] result = ['x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x'];
    i32s index = 0;
    for i in start to end {
        result[index] = source[i];
        index = index + 1;
    }
    return result;
}

fn replace_char(char[] text, i32s len, char old, char new) -> char[] {
    char[] result = ['x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x',
                     'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x', 'x'];
    for i in 0 to len {
        if text[i] == old {
            result[i] = new;
        } else {
            result[i] = text[i];
        }
    }
    return result;
}

fn main() -> i32s {
    char[] word1 = ['r', 'a', 'c', 'e', 'c', 'a', 'r'];
    i32s len1 = 7;
    
    println("Testing: racecar");
    println("");
    
    print("Is palindrome: ");
    println(is_palindrome(word1, len1));
    
    println("");
    
    print("Count of 'a': ");
    println(count_char(word1, len1, 'a'));
    
    println("");
    
    print("Count of 'c': ");
    println(count_char(word1, len1, 'c'));
    
    println("");
    
    print("First occurrence of 'c': ");
    println(find_first(word1, len1, 'c'));
    
    println("");
    
    print("Last occurrence of 'c': ");
    println(find_last(word1, len1, 'c'));
    
    println("");
    
    char[] reversed = reverse_string(word1, len1);
    println("Reversed (should be same):");
    for i in 0 to len1 {
        print(reversed[i]);
    }
    println("");
    println("");
    
    print("Original equals reversed: ");
    println(strings_equal(word1, reversed, len1));
    
    println("");
    
    char[] word2 = ['h', 'e', 'l', 'l', 'o'];
    i32s len2 = 5;
    
    print("Is 'hello' a palindrome: ");
    println(is_palindrome(word2, len2));
    
    println("");
    
    char[] replaced = replace_char(word2, len2, 'l', 'p');
    println("Replace 'l' with 'p' in hello:");
    for i in 0 to len2 {
        print(replaced[i]);
    }
    println("");
    println("");
    
    char[] substring = copy_substring(word2, 1, 4);
    println("Substring from index 1 to 4:");
    for i in 0 to 3 {
        print(substring[i]);
    }
    println("");
    println("");
    
    return 0;
}
`
            ,
            "Searching and Sorting": `fn bubble_sort(i32s[] arr, i32s len) -> i32s[] {
    i32s[] result = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    for i in 0 to len {
        result[i] = arr[i];
    }
    
    for i in 0 to len {
        for j in 0 to len {
            if j < len - 1 {
                if result[j] > result[j + 1] {
                    i32s temp = result[j];
                    result[j] = result[j + 1];
                    result[j + 1] = temp;
                }
            }
        }
    }
    
    return result;
}

fn binary_search(i32s[] arr, i32s len, i32s target) -> i32s {
    i32s left = 0;
    i32s right = len - 1;
    
    for iter in 0 to 100 {
        if left > right {
            return -1;
        }
        
        i32s mid = (left + right) / 2;
        
        if arr[mid] == target {
            return mid;
        }
        
        if arr[mid] < target {
            left = mid + 1;
        } else {
            right = mid - 1;
        }
    }
    
    return -1;
}

fn find_min_max(i32s[] arr, i32s len) -> i32s[] {
    i32s[] result = [0, 0];
    i32s min = arr[0];
    i32s max = arr[0];
    
    for i in 1 to len {
        if arr[i] < min {
            min = arr[i];
        }
        if arr[i] > max {
            max = arr[i];
        }
    }
    
    result[0] = min;
    result[1] = max;
    return result;
}

fn calculate_mean(f32s[] arr, i32s len) -> f32s {
    f32s sum = 0.0;
    for i in 0 to len {
        sum = sum + arr[i];
    }
    f32s length = 0.0;
    for i in 0 to len {
        length = length + 1.0;
    }
    return sum / length;
}

fn count_in_range(i32s[] arr, i32s len, i32s low, i32s high) -> i32s {
    i32s count = 0;
    for i in 0 to len {
        if arr[i] >= low {
            if arr[i] <= high {
                count = count + 1;
            }
        }
    }
    return count;
}

fn main() -> i32s {
    i32s[] numbers = [64, 34, 25, 12, 22, 11, 90, 88, 45, 50];
    i32s len = 10;
    
    println("Original array:");
    for i in 0 to len {
        print(numbers[i]);
        print("   ");
    }
    println("");
    println("");
    
    i32s[] sorted = bubble_sort(numbers, len);
    println("Sorted array:");
    for i in 0 to len {
        print(sorted[i]);
        print("   ");
    }
    println("");
    println("");
    
    i32s[] min_max = find_min_max(numbers, len);
    print("Min value: ");
    println(min_max[0]);
    
    println("");
    
    print("Max value: ");
    println(min_max[1]);
    
    println("");
    
    i32s search_target = 45;
    i32s index = binary_search(sorted, len, search_target);
    print("Index of 45 in sorted array: ");
    println(index);
    
    println("");
    
    i32s not_found = binary_search(sorted, len, 999);
    print("Index of 999 (not in array): ");
    println(not_found);
    
    println("");
    
    i32s count = count_in_range(numbers, len, 20, 60);
    print("Count of numbers between 20 and 60: ");
    println(count);
    
    println("");
    
    f32s[] float_nums = [1.5, 2.5, 3.5, 4.5, 5.5];
    f32s mean = calculate_mean(float_nums, 5);
    print("Mean of float array: ");
    println(mean);
    
    return 0;
}
`
        };

        const initialCode = examplePrograms["Verify Identity Matrix"];

        // Robust Highlighting Logic
        function updateHighlight() {
            let code = textarea.value;
            // Escape HTML
            code = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // Syntax coloring
            code = code.replace(/\/\/.*$/gm, '<span class="hl-cmt">$&</span>');
            code = code.replace(/"([^"\\]|\\.)*"/g, '<span class="hl-str">$&</span>');
            code = code.replace(/'([^'\\]|\\.)*'/g, '<span class="hl-str">$&</span>');
            code = code.replace(/\b(fn|return|if|else|for|in|to|exit)\b/g, '<span class="hl-kw">$1</span>');
            code = code.replace(/\b(print)\b/g, '<span class="hl-fn">$1</span>');
            code = code.replace(/\b(println)\b/g, '<span class="hl-fn">$1</span>');
            code = code.replace(/\b(i32s|f32s|bool|char|string)\b/g, '<span class="hl-type">$1</span>');
            code = code.replace(/\b(true|false)\b/g, '<span class="hl-atom">$1</span>');
            code = code.replace(/\b\d+(\.\d+)?\b/g, '<span class="hl-num">$&</span>');

            highlight.innerHTML = code + (code.endsWith('\n') ? ' ' : '\n');
            syncScroll();
        }

        function syncScroll() {
            highlight.scrollTop = textarea.scrollTop;
            highlight.scrollLeft = textarea.scrollLeft;
        }

        textarea.addEventListener('input', updateHighlight);
        textarea.addEventListener('scroll', syncScroll);

        // Tab & Auto-indent
        textarea.addEventListener('keydown', e => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                textarea.value = textarea.value.substring(0, start) + "    " + textarea.value.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + 4;
                updateHighlight();
            }
            if (e.key === 'Enter') {
                const start = textarea.selectionStart;
                const lines = textarea.value.substring(0, start).split('\n');
                const lastLine = lines[lines.length - 1];
                const indent = lastLine.match(/^\s*/)[0];
                const needsExtra = lastLine.trim().endsWith('{') ? '    ' : '';

                // Allow the newline to happen, then adjust
                setTimeout(() => {
                    const pos = textarea.selectionStart;
                    const before = textarea.value.substring(0, pos);
                    const after = textarea.value.substring(pos);
                    textarea.value = before + indent + needsExtra + after;
                    textarea.selectionStart = textarea.selectionEnd = pos + indent.length + needsExtra.length;
                    updateHighlight();
                }, 0);
            }
        });

        async function start() {
            try {
                await init();
                document.getElementById('status').textContent = "Ready";
            } catch (e) {
                document.getElementById('status').textContent = "Error Loading Library";
                console.error(e);
            }

            textarea.value = initialCode;
            updateHighlight();

            const runCompilation = () => {
                const code = textarea.value;
                const t0 = performance.now();
                try {
                    if (currentView === 'asm') {
                        outputArea.textContent = compile_g18(code);
                    } else {
                        outputArea.textContent = compile_wat_g18(code);
                    }
                    const t1 = performance.now();
                    document.getElementById('status').textContent = `Compiled in ${(t1 - t0).toFixed(1)}ms`;
                } catch (e) {
                    outputArea.textContent = "Compilation Error:\n" + e;
                }
            };

            compileBtn.onclick = () => {
                currentView = 'asm';
                runCompilation();
            };

            toggleBtn.onclick = () => {
                currentView = currentView === 'asm' ? 'wat' : 'asm';
                toggleBtn.textContent = currentView === 'asm' ? 'View WAT' : 'View ASM';
                runCompilation();
            };

            runBtn.onclick = async () => {
                consoleArea.textContent = "> Compiling and Running...\n";
                document.querySelector('.output-container').scrollIntoView({ behavior: 'smooth' });

                try {
                    const wasmBytes = compile_wasm_g18(textarea.value);
                    const importObject = {
                        env: {
                            // Updated: Remove + "\n" to let WASM control newlines
                            print_int: i => {
                                consoleArea.textContent += i;
                                consoleArea.scrollTop = consoleArea.scrollHeight;
                            },
                            print_str: ptr => {
                                if (!moduleMemory) return;
                                const view = new Uint8Array(moduleMemory.buffer, ptr);
                                let s = "";
                                for (let i = 0; view[i] !== 0; i++) s += String.fromCharCode(view[i]);
                                // Updated: Remove + "\n"
                                consoleArea.textContent += s;
                                consoleArea.scrollTop = consoleArea.scrollHeight;
                            },
                            // NEW: Add this function
                            print_float: f => {
                                consoleArea.textContent += f;
                                consoleArea.scrollTop = consoleArea.scrollHeight;
                            },
                            print_char: c => {
                                consoleArea.textContent += String.fromCharCode(c);
                                consoleArea.scrollTop = consoleArea.scrollHeight;
                            },
                            memory: new WebAssembly.Memory({ initial: 1 })
                        }
                    };
                    const { instance } = await WebAssembly.instantiate(wasmBytes, importObject);
                    moduleMemory = instance.exports.memory || importObject.env.memory;
                    if (instance.exports.main) {
                        const result = instance.exports.main();
                        consoleArea.textContent += `\n[Program exited with: ${result}]\n`;
                    }
                } catch (e) {
                    consoleArea.textContent += "Runtime Execution Error: " + e + "\n";
                }
            };
        }

        window.resetCode = () => {
            textarea.value = initialCode;
            updateHighlight();
        };

        window.copyOutput = () => {
            navigator.clipboard.writeText(outputArea.textContent).then(() => {
                const b = event.target;
                const old = b.textContent;
                b.textContent = "Copied!";
                setTimeout(() => b.textContent = old, 1500);
            });
        };

        const exampleSelect = document.getElementById('example-select');
        exampleSelect.addEventListener('change', (e) => {
            const selected = e.target.value;
            if (examplePrograms[selected]) {
                textarea.value = examplePrograms[selected];
                updateHighlight();
            }
        });

        start();
    </script>
</body>

</html>